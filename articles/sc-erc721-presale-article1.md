---
title: "ã€ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã€‘NFTãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«æ©Ÿèƒ½ã®å®Ÿè£…"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Ethereum", "ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ"]
published: false
---

# 1. ã¯ã˜ã‚ã«

æœ¬è¨˜äº‹ã§ã¯ã€ã€ŒPillheads NFTã€ã¨ã„ã†NFTãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å®Ÿè£…ã•ã‚ŒãŸã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«æ©Ÿèƒ½ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚
NFTãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã®è©³ç´°ã«ã¤ã„ã¦ã¯å‰²æ„›ã—ã¾ã™ã€‚

##### å‚è€ƒæ–‡çŒ®

- [Pillheads](https://www.pillheads.art/)
- [OpenSea - Pillheads NFT](https://opensea.io/ja/collection/pillheadsnft)
- [Etherscan - PILLHEADS](https://etherscan.io/address/0x1b23d0f0f6dc3547c1b6945152acbfd6eaad85b0#code)

## 1.2. ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ã¨ã¯

NFTã®ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ã¯ã€å…¬å¼è²©å£²å‰ã«ç‰¹å®šã‚°ãƒ«ãƒ¼ãƒ—ã«å…ˆè¡Œã—ã¦NFTã‚’ä½ä¾¡æ ¼ã§æä¾›ã™ã‚‹æœŸé–“ã§ã™ã€‚
ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ã‚’è¡Œã†ã“ã¨ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ã®æ—©æœŸæ”¯æŒã‚’é›†ã‚ã€è³‡é‡‘èª¿é”ã¨ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ§‹ç¯‰ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

## 1.3. Pillheads NFTã®ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«æ©Ÿèƒ½

1. ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ä¾¡æ ¼è¨­å®š
   - `setPresalePrice()` : ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ã®ä¾¡æ ¼ã‚’è¨­å®šã™ã‚‹é–¢æ•°
2. ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«æœŸé–“è¨­å®š
   - `setPresale1ActivationTime()`: ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1)ã®é–‹å§‹æ—¥æ™‚ã‚’è¨­å®šã™ã‚‹é–¢æ•°
   - `setPresale2ActivationTime()`: ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase2)ã®é–‹å§‹æ—¥æ™‚ã‚’è¨­å®šã™ã‚‹é–¢æ•°
3. å‚åŠ è³‡æ ¼è¨­å®š
   - `setPresale1MerkleRoot()`: ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1)ã®å‚åŠ è³‡æ ¼ã‚’æ¤œè¨¼ã™ã‚‹MerkleRootã‚’è¨­å®šã™ã‚‹é–¢æ•°
   - `setPresale2MerkleRoot()`: ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase2)ã®å‚åŠ è³‡æ ¼ã‚’æ¤œè¨¼ã™ã‚‹MerkleRootã‚’è¨­å®šã™ã‚‹é–¢æ•°
4. ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ç”¨ãƒŸãƒ³ãƒˆ
   - `mintPresale1()`: ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1)ä¸­ã«ãƒŸãƒ³ãƒˆã‚’ã™ã‚‹é–¢æ•°
   - `mintPresale2()`: ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase2)ä¸­ã«ãƒŸãƒ³ãƒˆã‚’ã™ã‚‹é–¢æ•°

# 2. ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ

## 2.1. ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ä¾¡æ ¼è¨­å®š

`setPresalePrice`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«æ™‚ã®NFTä¾¡æ ¼ã‚’è¨­å®šã§ãã¾ã™ã€‚
ã¾ãŸé–¢æ•°ã¯ã€ç®¡ç†è€…ã®ã¿ãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«åˆ¶å¾¡ã•ã‚Œã¦ã„ã¾ã™ã€‚
`presalePrice`å¤‰æ•°ã«ã¯ã€åˆæœŸå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

```solidity
/// åˆæœŸä¾¡æ ¼: 0.1ETH (100000000000000000 Wei)
uint256 public presalePrice = 100000000000000000;

/// @dev ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ã®ä¾¡æ ¼ã‚’è¨­å®šã™ã‚‹é–¢æ•°
/// @param price æ–°ã—ã„ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ä¾¡æ ¼(Weiå˜ä½)
function setPresalePrice(uint256 price) external onlyAdmin {
    presalePrice = price;
}
```

## 2.2. ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«æœŸé–“è¨­å®š

`setPresale1ActivationTime`é–¢æ•°ã¨`setPresale2ActivationTime`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ã®é–‹å§‹æ™‚åˆ»ã‚’è¨­å®šã§ãã¾ã™ã€‚
ã¾ãŸé–¢æ•°ã¯ã€ç®¡ç†è€…ã®ã¿ãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«åˆ¶å¾¡ã•ã‚Œã¦ã„ã¾ã™ã€‚
`presale1ActivationTime`å¤‰æ•°ã¨`presale2ActivationTime`å¤‰æ•°ã«ã¯ã€åˆæœŸå€¤ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

```solidity
// åˆæœŸå€¤: ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1) 2022å¹´6æœˆ16æ—¥ 20:20
uint256 public presale1ActivationTime = 1655410800;
// åˆæœŸå€¤: ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase2) 2022å¹´6æœˆ18æ—¥ 20:20
uint256 public presale2ActivationTime = 1655583600;

/// @dev ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1)ã®é–‹å§‹æ™‚åˆ»ã‚’è¨­å®šã™ã‚‹é–¢æ•°
/// @param timestampInSeconds æ–°ã—ã„é–‹å§‹æ™‚åˆ»(UNIXã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—)
function setPresale1ActivationTime(uint256 timestampInSeconds) external onlyAdmin {
    presale1ActivationTime = timestampInSeconds;
}

/// @dev ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase2)ã®é–‹å§‹æ™‚åˆ»ã‚’è¨­å®šã™ã‚‹é–¢æ•°
/// @param timestampInSeconds æ–°ã—ã„é–‹å§‹æ™‚åˆ»(UNIXã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—)
function setPresale2ActivationTime(uint256 timestampInSeconds) external onlyAdmin {
    presale2ActivationTime = timestampInSeconds;
}
```

## 2.3. å‚åŠ è³‡æ ¼è¨­å®š

å‚åŠ è³‡æ ¼ã¯ã€OpenZeppelinã®MerkleProofã¨ã„ã†ä»•çµ„ã¿ã‚’åˆ©ç”¨ã—ã¦ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã®ä»•çµ„ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå´ã§å‚åŠ è€…ãƒªã‚¹ãƒˆã‚’ä¿æŒã™ã‚‹å¿…è¦ãŒãªãã€bytes32å‹ã®æ–‡å­—åˆ—(é€šç§°: MerkeRoot)ã‚’ä¿æŒã™ã‚‹ã ã‘ã§è³‡æ ¼ã®æ¤œè¨¼ãŒå¯èƒ½ã§ã™ã€‚

https://docs.openzeppelin.com/contracts/5.x/api/utils#MerkleProof

`setPresale1MerkleRoot`é–¢æ•°ã¨`setPresale2MerkleRoot`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ã®å‚åŠ è³‡æ ¼ã‚’æ¤œè¨¼ã™ã‚‹MerkleRootã‚’è¨­å®šã§ãã¾ã™ã€‚
ã¾ãŸé–¢æ•°ã¯ã€ç®¡ç†è€…ã®ã¿ãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«åˆ¶å¾¡ã•ã‚Œã¦ã„ã¾ã™ã€‚

```solidity
/// åˆæœŸå€¤: ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1)
bytes32 private presale1Root = bytes32(0);
/// åˆæœŸå€¤: ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase2)
bytes32 private presale2Root = bytes32(0);

/// @dev ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1)ã®å‚åŠ è³‡æ ¼ã‚’è¨­å®šã™ã‚‹é–¢æ•°
/// @param newRoot æ–°ã—ã„MerkleRoot
function setPresale1MerkleRoot(bytes32 newRoot) external onlyAdmin {
    presale1Root = newRoot;
}

/// @dev ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1)ã®å‚åŠ è³‡æ ¼ã‚’è¨­å®šã™ã‚‹é–¢æ•°
/// @param newRoot æ–°ã—ã„MerkleRoot
function setPresale2MerkleRoot(bytes32 newRoot) external onlyAdmin {
    presale2Root = newRoot;
}
```

## 2.4. ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ç”¨ãƒŸãƒ³ãƒˆ

`mintPresale1`é–¢æ•°ã¨`mintPresale2`é–¢æ•°ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«æœŸé–“ã«ãƒŸãƒ³ãƒˆã‚’è¡Œãˆã¾ã™ã€‚

```solidity
/// ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1)ã®ãƒŸãƒ³ãƒˆé–¢æ•°
/// @param maxMints æœ€å¤§ãƒŸãƒ³ãƒˆæ•°é‡
/// @param sigV ç½²å
/// @param sigR ç½²å
/// @param sigS ç½²å
/// @param merkleProof ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ã®å‚åŠ è³‡æ ¼ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®MerkleProof
/// @param amount ãƒŸãƒ³ãƒˆã™ã‚‹æ•°é‡
function mintPresale1(
    uint256 maxMints,
    uint8 sigV,
    bytes32 sigR,
    bytes32 sigS,
    bytes32[] calldata merkleProof,
    uint256 amount
)
    public
    payable
{
    require(presale1Activated(), "TooEarly");
    require(amount <= mintsLeft, "ExceedsSupply");
    require(presalePrice * amount == msg.value, "BadPrice");
    require(verify(msg.sender, sigV, sigR, sigS) == true, "BadSignature");
    require(checkPresale1MerkleProof(merkleProof, maxMints), "BadProof");
    require(amount <= maxMints, "ExceedsPresaleMax");
    require(!presale1Claimed[msg.sender], "Claimed");

    // amountã®å›æ•°åˆ†ã€ãƒŸãƒ³ãƒˆå‡¦ç†
    for(uint i; i < amount;) {
        // ç¬¬ä¸€å¼•æ•°ã«NFTã‚’å—ã‘å–ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ç¬¬äºŒå¼•æ•°ã«TokenIDã‚’æŒ‡å®šã—ã¦ãƒŸãƒ³ãƒˆã‚’å®Ÿè¡Œ
        // TokenID = MINTS_MAX - mintsLeft + 1
        _safeMint(msg.sender, MINTS_MAX - mintsLeft + 1);
        // ãƒŸãƒ³ãƒˆã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã®æ•°ã‚’æ¸›ã‚‰ã™ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’ç„¡åŠ¹ï¼‰
        unchecked { mintsLeft--; }
        // æ¬¡ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«é€²ã‚€ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ãƒã‚§ãƒƒã‚¯ã‚’ç„¡åŠ¹ï¼‰
        unchecked { i++; }
    }

    // ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1)ã§ã®å†å‚åŠ ã‚’é˜²ããŸã‚ã®ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    unchecked { presale1Claimed[msg.sender] = true; }
}
```

### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```solidity
// ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1)ãŒé–‹å§‹ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(presale1Activated(), "TooEarly");
// ãƒŸãƒ³ãƒˆæ•°ãŒTotalSupplyã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(amount <= mintsLeft, "ExceedsSupply");
// æ”¯æ‰•ã„é‡‘é¡ãŒè²©å£²é‡‘é¡ã¨ä¸€è‡´ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(presalePrice * amount == msg.value, "BadPrice");
// ç½²åãŒæœ‰åŠ¹ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(verify(msg.sender, sigV, sigR, sigS) == true, "BadSignature");
// ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase1)ã®MerkleProofãŒä¸€è‡´ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(checkPresale1MerkleProof(merkleProof, maxMints), "BadProof");
// ãƒŸãƒ³ãƒˆæ•°ãŒæœ€å¤§ãƒŸãƒ³ãƒˆæ•°ä»¥ä¸Šã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(amount <= maxMints, "ExceedsPresaleMax");
// æ—¢ã«ãƒŸãƒ³ãƒˆæ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(!presale1Claimed[msg.sender], "Claimed");
```

# é–¢æ•°: mintPresale2

```solidity
/// ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase2)ã®ãƒŸãƒ³ãƒˆé–¢æ•°
/// @param sigV ç½²å
/// @param sigR ç½²å
/// @param sigS ç½²å
/// @param merkleProof ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«ã®å‚åŠ è³‡æ ¼ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®MerkleProof
/// @param amount ãƒŸãƒ³ãƒˆã™ã‚‹æ•°é‡
function mintPresale2(
    uint8 sigV,
    bytes32 sigR,
    bytes32 sigS,
    bytes32[] calldata merkleProof,
    uint256 amount
)
    public
    payable
{
    require(presale2Activated(), "TooEarly");
    require(amount <= mintsLeft, "ExceedsSupply");
    require(presalePrice * amount == msg.value, "BadPrice");
    require(verify(msg.sender, sigV, sigR, sigS) == true, "BadSignature");
    require(checkPresale2MerkleProof(merkleProof), "BadProof");
    require(amount <= 2, "ExceedsPresaleMax");
    require(!presale2Claimed[msg.sender], "Claimed");

    // mint their tokens
    for(uint i; i < amount;) {
      // reduce the total pop after minting
      _safeMint(msg.sender, MINTS_MAX - mintsLeft + 1);
      unchecked { mintsLeft--; }
      unchecked { i++; }
    }

    // lock them out of re-entering presale 2
    unchecked { presale2Claimed[msg.sender] = true; }
  }
```

### ä¿®é£¾å­

```solidity
public /// å…¬é–‹é–¢æ•°
payable /// Etherã‚’é€é‡‘ã™ã‚‹ã“ã¨ãŒã§ãã‚‹
```

### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```solidity
// ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase2)ãŒé–‹å§‹ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(presale2Activated(), "TooEarly");
// ãƒŸãƒ³ãƒˆæ•°ãŒTotalSupplyã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(amount <= mintsLeft, "ExceedsSupply");
// æ”¯æ‰•ã„é‡‘é¡ãŒè²©å£²é‡‘é¡ã¨ä¸€è‡´ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(presalePrice * amount == msg.value, "BadPrice");
// ç½²åãŒæœ‰åŠ¹ã§ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(verify(msg.sender, sigV, sigR, sigS) == true, "BadSignature");
// ãƒ—ãƒ¬ã‚»ãƒ¼ãƒ«(Phase2)ã®MerkleProofãŒä¸€è‡´ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(checkPresale2MerkleProof(merkleProof), "BadProof");
// ãƒŸãƒ³ãƒˆæ•°ãŒ2ä»¥ä¸Šã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(amount <= 2, "ExceedsPresaleMax");
// æ—¢ã«ãƒŸãƒ³ãƒˆæ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
require(!presale2Claimed[msg.sender], "Claimed");
```
